import json
import re
import subprocess

def format_data(file_path):

    with open(file_path,'r') as f:
        data = json.load(f)

    base_dico_for_exploit_search = {}

    for ip, details in data.items():
        base_dico_for_exploit_search[ip] = {}
        print(f"IP Address: {ip}")
        for port_info in details['ports']:
            port = port_info['port']['port_id']
            product = port_info['service']['product']
            version = port_info['service']['version'].split(" ")[0]
            match = re.match(r"(\d+\.\d+\.\d+)",version)
            if match:
                version = match.group(1)

            if product != 'None' and version != 'None':
                print(f"  Port: {port}, Product: {product}, Version: {version}")
                base_dico_for_exploit_search[ip][port]= {"Product":product,
                                                         "Version":version}
    return base_dico_for_exploit_search

def launch_searchploit(data):

    RED = "\033[0;31m"
    GREEN = "\033[0;32m"
    BLUE = "\033[0;34m"
    COLOR_OFF = "\033[0m"

    for ip in data.keys():
        for port in data[ip].keys():
            command = f"searchsploit {port['Product']} {port['Version']}"        
            result = subprocess.run(command,stderr=subprocess.PIPE, shell=True, executable="/bin/bash")

            if result.stderr:
                print(f"{RED}Erreur lors de l'execution: {COLOR_OFF}")
                print(result.stderr)
            else:
                print(f"{GREEN}Nmap vulners script done{COLOR_OFF}")
                print(f"{BLUE}le fichier existe: {COLOR_OFF}")
    print(data)

